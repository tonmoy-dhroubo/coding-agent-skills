#!/usr/bin/env bash
set -euo pipefail

payload='''{{PAYLOAD_JSON}}'''

if ! command -v jq >/dev/null 2>&1; then
  echo "jq is required for the bash runner" >&2
  exit 1
fi

base_url=$(echo "$payload" | jq -r '.config.baseUrl // "http://localhost:8080"')
report_path=$(echo "$payload" | jq -r '.report_path')
artifacts_dir=$(echo "$payload" | jq -r '.artifacts_dir')
retries=$(echo "$payload" | jq -r '.config.retries // 1')
allow_delete=$(echo "$payload" | jq -r '.config.allowDelete // false')

mkdir -p "$(dirname "$report_path")" "$artifacts_dir"

results="[]"
index=0

run_request() {
  local method="$1"
  local url="$2"
  local body="$3"

  local args=("-sS" "-w" "%{http_code}" "-m" "10" "-X" "$method")
  if [ -n "$body" ]; then
    args+=("-H" "Content-Type: application/json" "-d" "$body")
  fi

  local response
  response=$(curl "${args[@]}" "$url")
  local status="${response: -3}"
  local content="${response::-3}"
  echo "$status" "${content}"
}

plan_len=$(echo "$payload" | jq '.plan | length')
for ((i=0; i<plan_len; i++)); do
  method=$(echo "$payload" | jq -r ".plan[$i].method")
  path=$(echo "$payload" | jq -r ".plan[$i].path")
  payload_body=$(echo "$payload" | jq -c ".plan[$i].payload // empty")

  if [ "$method" = "DELETE" ] && [ "$allow_delete" != "true" ]; then
    continue
  fi

  url="${base_url%/}${path}"
  status=0
  content=""
  for ((attempt=0; attempt<=retries; attempt++)); do
    read -r status content < <(run_request "$method" "$url" "$payload_body")
    if [ "$status" -lt 500 ] && [ "$status" -ne 0 ]; then
      break
    fi
    sleep 0.2
  done

  index=$((index+1))
  artifact_file="$artifacts_dir/$(printf "%02d" "$index")_${method}_$(echo "$path" | tr '/:' '__').json"
  printf '{"method":"%s","path":"%s","status":%s,"response":%s}\n' "$method" "$path" "$status" "$(jq -Rsa . <<<"$content")" > "$artifact_file"

  results=$(jq -c ". += [{method:\"$method\", path:\"$path\", status:$status, latency_ms:0, notes:\"${status}\"}]" <<<"$results")

done

{
  echo "# API Test Report"
  echo ""
  echo "| Method | Path | Status | Latency (ms) | Notes |"
  echo "| --- | --- | --- | --- | --- |"
  echo "$results" | jq -r '.[] | "| \(.method) | \(.path) | \(.status) | \(.latency_ms) | \(.notes) |"'
} > "$report_path"

echo "$results" | jq '{results: .}' > "${report_path%.md}.json"
